<!DOCTYPE html>
<html lang="en">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
		<title>NZB MegasearcH &mdash; Configure</title>

		<link rel="stylesheet" type="text/css" href="static/reset2.css" />
		<link rel="stylesheet" type="text/css" href="static/style.css" />

		<script type=text/javascript>
		  var $SCRIPT_ROOT = {{ request.script_root|tojson|safe }};
		</script>
	</head>
	<body>
		<div id="container">
		<p><a href="/">&larr; Back</a></p>
		<form action="/" method="post" name="cfgform" id="config-form">
			<fieldset id="general">
				<legend>General Options (requires restart)</legend>
				{% if openshift_install == False %}
				<p><label for="port">Port: </label><input type="text" name="port" id="port" value="{{ genopt['portno']}}" size="7" maxlength="5" /></p>
				{% else %}
				<input type="hidden" name="port" id="port" value="{{ genopt['portno']}}" />
				{% endif %}
				<p><label for="https">HTTPS Enabled: </label><input type="checkbox" name="https" id="https" {{ genopt['general_https_verbose'] }} /></p>
			</fieldset>

			<fieldset id="security">
				<legend>Security Options</legend>

				<h1>HTTP Authentication</h1>
				<p>Leave these fields blank to allow unauthenticated access.</p>
				<p><label for="general_usr">Username: </label><input type="text" name="general_usr" id="general_usr" value="{{ genopt['general_usr'] }}" size="18" /></p>
				<p><label for="general_pwd">Password: </label><input type="password" name="general_pwd" id="general_pwd" value="{{ genopt['general_pwd'] }}" size="18" /></p>

				<h1>Config Page Authentication</h1>
				<p>Leave these fields blank to allow unauthenticated access.</p>
				<p><label for="config_user">Username: </label><input type="text" name="config_user" id="config_user" value="{{ genopt['config_user'] }}" size="18" /></p>
				<p><label for="config_pwd">Password: </label><input type="password" name="config_pwd" id="config_pwd" value="{{ genopt['config_pwd'] }}" size="18" /></p>

				<h1>API Key</h1>
				<p>Below is an API key that can be used with Sickbeard and CouchPotato. If the box is empty, click &quot;Generate Key&quot; to generate a new key.</p>
				<p>
					<input type="button" value="Generate Key" onclick="generate_key()" />
					<label for="general_apikey"></label><input type="text" name="general_apikey" id="general_apikey" value="{{ genopt['general_apikey'] }}" size="16" readonly />
					<input type="button" value="Delete Key" onclick="delete_key()" />
				</p>
			</fieldset>

			<fieldset id="suggestions-trends">
				<legend>Suggestions and Trends</legend>
				<p><input type="checkbox" name="trends" id="trends" {{ genopt['general_trend_verbose'] }} />&nbsp;<label for="trends">Movie and Show Trends Active</label></p>
				<p><input type="checkbox" name="sugg" id="sugg" {{ genopt['general_suggestion_verbose'] }} />&nbsp;<label for="sugg">Search Suggestions Active</label></p>
				<p>
					<label for="seltrqty">Number of suggestions/trends to show </label>
					<select name="seltrqty">
						<option value="5">5 (default)</option>	
						{% for tnarray_el in tnarray -%}
							<option value='{{ tnarray_el[0] }}' {{ tnarray_el[2]}}>{{ tnarray_el[1] }}</option>
						{%- endfor %}
					</select>
				</p>
			</fieldset>

			<fieldset id="search-options">
				<legend>Search Options</legend>
				<p>
					<label for="selcat">Default Category: </label>
					<select name="selcat" id="selcat">
						<option value="" selected>No category</option>
						{% for sopt in selectable_opt -%}
							<option value={{ sopt[0] }} {{ sopt[2] }}>{{ sopt[1] }}</option>
						{%- endfor %}
					</select>
				</p>
				<p><input type="checkbox" name="smartsearch" id="smartsearch" value="1" size="40" {{ genopt['smartsearch_verbose'] }} />&nbsp;<label for="smartsearch">Smartsearch (suggested -- removes weak matches)</label></p>
				<p><input type="checkbox" name="cache_active" id="cache_active" value="1" size="40" {{ genopt['cache_active_verbose'] }} />&nbsp;<label for="max_cache_qty">Cache results (suggested)</label></p>
				<p><input type="checkbox" name="predb_active" id="predb_active" value="1" size="40" {{ genopt['predb_active_verbose'] }} />&nbsp;<label for="predb_active">PreDB release matching (suggested) [experimental]</label></p>
				<p><label for="searchaddontxt">Appended search terms, eg: 'R6 -german -french': </label><input type="text" name="searchaddontxt" id="searchaddontxt" value="{{ genopt['searchaddontxt'] }}" size="19" /></p>
			</fieldset>

			<fieldset id="sab-integration">
				<legend>SABnzbd Integration</legend>
				<p><label for="sabnzbd_url">URL: </label>&nbsp;<input type="text" name="sabnzbd_url" id="sabnzbd_url" value="{{ genopt['sabnzbd_url'] }}" size="22" /></p>
				<p><label for="sabnzbd_api">API Key: </label>&nbsp;<input type="text" name="sabnzbd_api" id="sabnzbd_api" value="{{ genopt['sabnzbd_api'] }}" size="22" /></p>
				<p><input type="button" value="Detect megasearch IP/host" onclick="detect_ip()" /><label for="general_ipaddress"></label><input type="text" name="general_ipaddress" id="general_ipaddress" value="{{ genopt['general_ipaddress_verbose'] }}" size="14" /><input type="button" value="Auto" onclick="cfgform.general_ipaddress.value='AUTO'" /></p>
			</fieldset>

			<fieldset id="nzbget-integration">
				<legend>NZBGet Integration</legend>
				<p><label for="nzbget_url">URL (host:port): </label><input type="text" name="nzbget_url" id="nzbget_url" value="{{ genopt['nzbget_url'] }}" size="15" /></p>
				<p><label for="nzbget_user">Username: </label><input type="text" name="nzbget_user" id="nzbget_user" value="{{ genopt['nzbget_user'] }}" size="15" /></p>
				<p><label for="nzbget_pwd">Password: </label><input type="password" name="nzbget_pwd" id="nzbget_pwd" value="{{ genopt['nzbget_pwd'] }}" size="15" /></p>
			</fieldset>

			<fieldset id="special-engines">
				<legend>Specially-supported Engines</legend>
				{% for c in cfg_bi -%}
					{% if c['flogin'] == 0-%}
						<p><input type="checkbox" name="bi_host{{ c['idx'] }}active" id="bi_host{{ c['idx'] }}active" value="1" {{ c['stchk'] }} />&nbsp;<label for="bi_host{{ c['idx'] }}active">{{ c['humanname'] }}</label><input type="hidden" name="bi_host{{ c['idx'] }}" value="{{ c['type'] }}" /><input type="hidden" name="bi_host{{ c['idx'] }}url" value="{{ c['url'] }}" /><input type="hidden" name="bi_host{{ c['idx'] }}speed" value="{{ c['speed_class'] }}" /></p>
					{%- endif %}
				{%- endfor %}
			</fieldset>

			<fieldset id="other-engines">
				<legend>Other Supported Engines</legend>
				{% for c in cfg_bi -%}
					{% if c['flogin'] == 1-%}
						<fieldset>
							<legend><input type="checkbox" name="bi_host{{ c['idx'] }}active" id="bi_host{{ c['idx'] }}active" value="1" {{ c['stchk'] }}>&nbsp;<label for="bi_host{{ c['idx'] }}active">{{ c['humanname'] }}</label></legend>
							<input type="hidden" name="bi_host{{ c['idx'] }}" value="{{ c['type'] }}" />
							<input type="hidden" name="bi_host{{ c['idx'] }}url" value="{{ c['url'] }}" />
							<input type="hidden" name="bi_host{{ c['idx'] }}speed" value="{{ c['speed_class'] }}" />

							<p>
								<label for="bi_host{{ c['idx'] }}login">{{ c['flogin_caption_user'] }}:</label> 
								<input type="text" name="bi_host{{ c['idx'] }}login" id="bi_host{{ c['idx'] }}login" value="{{ c['loginname'] }}" size="12" />
							</p>
							<p>
								<label for="bi_host{{ c['idx'] }}pwd">{{ c['flogin_caption_pwd'] }}:</label> 
								<input type="password" name="bi_host{{ c['idx'] }}pwd" id="bi_host{{ c['idx'] }}pwd" value="{{ c['loginpwd'] }}" size="12" />
							</p>
						</fieldset>
					{%- endif %}
				{%- endfor %}
			</fieldset>

			<fieldset id="newznab">
				<legend>Newznab</legend>
				<table class="tabular-form">
					<thead>
						<tr>
							<th></th><th>Host</th><th>API Key</th><th>Timeout</th><th>Active</th>
						</tr>
					</thead>
					<tbody>
				{% for c in cfg -%}
					{% if c['builtin'] == 0-%}
						<tr>
							<td>{{ c['idx']+1 }})</td>
							<td>
								<label for="host{{ c['idx'] }}" class="visuallyhidden">Newznab Host (API)</label>
								<input type="text" name="host{{ c['idx'] }}" id="host{{ c['idx'] }}" value="{{ c['url'] }}" />
							</td>
							<td>
								<label for="API{{ c['idx'] }}" class="visuallyhidden">API key</label>
								<input type="text" name="API{{ c['idx'] }}" id="API{{ c['idx'] }}" value="{{ c['api'] }}" />
								<input type="hidden" name="type{{ c['idx'] }}" value="NAB" /><input type="hidden" name="host{{ c['idx'] }}active" value="1" />
							</td>
							<td>
								<label for="selspeed{{ c['idx'] }}" class="visuallyhidden">Timeout</label>
								<select name="selspeed{{ c['idx'] }}" id="selspeed{{ c['idx'] }}">
									{% for sopt in c['selspeed_sel'] -%}
										<option value={{ sopt[0] }} {{ sopt[2] }}>{{ sopt[1] }}</option>
									{%- endfor %}
								</select>
							</td>
							<td>
								<input type="checkbox" name="valid{{ c['idx'] }}" id="valid{{ c['idx'] }}"  {{c['valid_verbose'] }} >
							</td>
						</tr>
					{%- endif %}
				{%- endfor %}
				{% for q in range(cnt,cnt_max) -%}
					<tr>
						<td>{{ q+1 }})</td>
						<td>
							<label for="host{{ q }}" class="visuallyhidden">Newznab Host (API)</label>
							<input type="text" name="host{{ q }}" id="host{{ q }}" />
						</td>
						<td>
							<label for="API{{ q }}" class="visuallyhidden">API key</label>
							<input type="text" name="API{{ q }}" id="API{{ q }}" />
							<input type="hidden" name="type{{ q }}" value="NAB" />
						</td>

						<td>
							<label for="selspeed{{ q }}" class="visuallyhidden">Timeout</label>
							<select  name="selspeed{{ q }}" id="selspeed{{ q }}">
								{% for sopt in sel_speedopt_basic -%}
									<option value={{ sopt[0] }} {{ sopt[2] }}>{{ sopt[1] }}</option>
								{%- endfor %}
							</select>
						</td>

						<td>
							<input type="checkbox" name="valid{{ q }}" id="valid{{ q }}" checked=yes >
							<label for="valid{{ q }}" class="visuallyhidden">Active</label>
						</td>
					</tr>
				{%- endfor %}
					</tbody>
				</table>

				<table class="tabular-form">
					<thead>
						<tr>
							<th></th><th>Host</th><th>Username</th><th>Password</th><th>Timeout</th><th>Active</th>
						</tr>
					</thead>
					<tbody>
						{% for c in cfg_dp -%}
						<tr>
							<td>{{ c['idx']+1 }})</td>
							<td>
								<label for="ds_host{{ c['idx'] }}" class="visuallyhidden">Newznab Host (Web)</label>
								<input type="text" name="ds_host{{ c['idx'] }}" id="ds_host{{ c['idx'] }}" value="{{ c['url'] }}" />
							</td>
							<td>
								<label for="ds_usr{{ c['idx'] }}" class="visuallyhidden">Username</label>
								<input type="text" name="ds_usr{{ c['idx'] }}" id="ds_usr{{ c['idx'] }}" value="{{ c['user'] }}" />
							</td>
							<td>
								<label for="ds_pass{{ c['idx'] }}" class="visuallyhidden">Password</label>
								<input type="password" name="ds_pass{{ c['idx'] }}" id="ds_pass{{ c['idx'] }}" value="{{ c['pwd'] }}" />
								<input type="hidden" name="ds_type{{ c['idx'] }}" value="DSN" size="40">
							</td>
							<td>
								<label for="ds_selspeed{{ c['idx'] }}" class="visuallyhidden">Timeout</label>
								<select  name="ds_selspeed{{ c['idx'] }}" id="ds_selspeed{{ c['idx'] }}">
									{% for sopt in c['selspeed_sel'] -%}
										<option value={{ sopt[0] }} {{ sopt[2] }}>{{ sopt[1] }}</option>
									{%- endfor %}
								</select>
							</td>
							<td>
								<input type="checkbox" name="ds_valid{{ c['idx'] }}" id="ds_valid{{ c['idx'] }}" {{c['valid_verbose'] }} />
								<label for="ds_valid{{ c['idx'] }}" class="visuallyhidden">Active</label>
							</td>
						</tr>
						{%- endfor %}
						{% for q in range(cnt_ds,cnt_max) -%}
						<tr>
							<td>{{ q+1 }})</td>
							<td>
								<label for="ds_host{{ q }}" class="visuallyhidden">Newznab Host (Web)</label>
								<input type="text" name="ds_host{{ q }}" id="ds_host{{ q }}" />
							</td>
							<td>
								<label for="ds_usr{{ q }}" class="visuallyhidden">Username</label>
								<input type="text" name="ds_usr{{ q }}" id="ds_usr{{ q }}" />
							</td>
							<td>
								<label for="ds_pass{{ q }}" class="visuallyhidden">Password</label>
								<input type="password" name="ds_pass{{ q }}" id="ds_pass{{ q }}" />
								<input type="hidden" name="ds_type{{ q }}" value="DSN" />
							</td>

							<td>
								<label for="ds_selspeed{{ q }}" class="visuallyhidden">Timeout</label>
								<select name="ds_selspeed{{ q }}" id="ds_selspeed{{ q }}">
									{% for sopt in sel_speedopt_basic -%}
										<option value={{ sopt[0] }} {{ sopt[2] }}>{{ sopt[1] }}</option>
									{%- endfor %}
								</select>
							</td>

							<td>
								<input type="checkbox" name="ds_valid{{ q }}" id="ds_valid{{ q }}" checked=yes />
								<label for="ds_valid{{ q }}" class="visuallyhidden">Active</label>
							</td>
						</tr>
						{%- endfor %}
					</tbody>
				</table>
			</fieldset>

			<input type="submit" value="Save" onclick="return check_form_correctness()" />
			<input type="button" value="Cancel" onclick="location.href=&#39;\/&#39;;" />
		</form>
		</div>
		<script type="text/javascript">
			function detect_ip()
			{
				cfgform.general_ipaddress.value="{{ cdomainname }}";
			}
			
			function generate_key()
			{
				varkey = Math.random().toString(36).slice(2);
				cfgform.general_apikey.value=varkey;
			}
			function delete_key()
			{
				cfgform.general_apikey.value='';
			}

			function check_form_correctness()
			{

				var port_v = cfgform.port.value;
				chk1 = /^\d+$/.test(port_v);
				if(!chk1 || (chk1==true && (parseInt(port_v)> 65535 ||  parseInt(port_v)< 1024 )) )
				{
					alert('ERROR: [Port] is a number-only field between [1024,65535]');
					return false
				}

				var usr_v = cfgform.general_usr.value.replace(/\s+/g, ' ')
				var pwd_v = cfgform.general_pwd.value.replace(/\s+/g, ' ')
				if (((usr_v.length == 0) && (pwd_v.length > 0)) || ((usr_v.length > 0) && (pwd_v.length == 0)))
				{
					alert('ERROR: [User and Password] must be either both empty or both filled');
					return false
				}


				var usrc_v = cfgform.config_user.value.replace(/\s+/g, ' ')
				var pwdc_v = cfgform.config_pwd.value.replace(/\s+/g, ' ')
				if (((usrc_v.length == 0) && (pwdc_v.length > 0)) || ((usrc_v.length > 0) && (pwdc_v.length == 0)))
				{
					alert('ERROR: [Config User and Password] must be either both empty or both filled');
					return false
				}

				var sabnzbd_url_v = cfgform.sabnzbd_url.value.replace(/\s+/g, ' ')
				var sabnzbd_api_v = cfgform.sabnzbd_api.value.replace(/\s+/g, ' ')
				var cb = check_beginning_http(sabnzbd_url_v)
				if ((sabnzbd_api_v.length > 0) && (sabnzbd_url_v.length == 0) || !cb)
				{
					alert('ERROR: [SAB url and api] url missing with provided API key.\nUrl must begin with http(s)://');
					return false
				}

				{% for c in cfg_bi -%}
					{% if c['flogin'] == 1-%}
						var bi_login_v{{ q }} = cfgform.bi_host{{ c['idx'] }}login.value.replace(/\s+/g, ' ')
						var bi_pwd_v{{ q }} = cfgform.bi_host{{ c['idx'] }}pwd.value.replace(/\s+/g, ' ')
						var bi_active_v{{ q }} = cfgform.bi_host{{ c['idx'] }}active.checked
						if ( ((bi_login_v{{ q }}.length == 0) || (bi_pwd_v{{ q }}.length == 0)) && bi_active_v{{ q }} )
						{
							alert('ERROR: Enter user and password for {{ c['humanname'] }}');
							return false
						}
					{%- endif %}
				{%- endfor %}

				{% for q in range(0,cnt_max) -%}
					<!-- -->
					var host{{ q }} = cfgform.host{{ q }}.value.replace(/\s+/g, ' ')
					var hostapi{{ q }} = cfgform.API{{ q }}.value.replace(/\s+/g, ' ')
					var cb = check_beginning_http(host{{ q }})

					if ((host{{ q }}.length == 0) && (hostapi{{ q }}.length > 0) || !cb)
					{
						alert('ERROR: Newznab Host (API) #{{ q+1 }}. Enter url for the given API.\nUrl must begin with http(s)://');
						return false
					}
				{%- endfor %}

				{% for q in range(0,cnt_max) -%}
					<!-- -->
					var ds_host{{ q }} = cfgform.ds_host{{ q }}.value.replace(/\s+/g, ' ')
					var ds_usr{{ q }} = cfgform.ds_usr{{ q }}.value.replace(/\s+/g, ' ')
					var ds_pass{{ q }} = cfgform.ds_pass{{ q }}.value.replace(/\s+/g, ' ')
					var cb = check_beginning_http(ds_host{{ q }})
					var err = 0

					if(!cb)
					{
						err = 1;
					}
					if ((ds_pass{{ q }}.length == 0) && (ds_usr{{ q }}.length > 0))
					{
						err = 1;
					}
					if ((ds_pass{{ q }}.length > 0) && (ds_usr{{ q }}.length == 0))
					{
						err = 1;
					}
					if ((ds_host{{ q }}.length > 0) && ( (ds_pass{{ q }}.length == 0) && (ds_usr{{ q }}.length == 0)  ) )
					{
						err = 1;
					}
					if ((ds_host{{ q }}.length == 0) && ( err == 1  ) )
					{
						err = 1;
					}
					if ((ds_host{{ q }}.length > 0) && ( err == 1  ) )
					{
						err = 1;
					}

					if (err == 1)
					{
						alert('ERROR: Newznab Web  #{{ q+1 }}. Enter url, username and password.\nUrl must begin with http(s)://');
						return false
					}

				{%- endfor %}
			}


			function check_beginning_http(string_to_chk)
			{
				if(string_to_chk.length == 0)
				{
					return true
				}

				var pattern = /^((http|https|ftp):\/\/)/;
				if(!pattern.test(string_to_chk))
				{
					return false
				}
				return true
			}
		</script>
</body>
</html>

